name: Post-Merge Cleanup (assign sidebar, imports, components)

on:
  pull_request:
    branches: [stg]
    types: [closed]

jobs:
  cleanup:
    if: startsWith(github.head_ref, 'cms/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: Checkout stg branch (after merge)
        if: ${{ github.event.action == 'closed' && github.event.pull_request.merged == true }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        if: ${{ github.event.action == 'closed' && github.event.pull_request.merged == true }}
        run: npm ci

      - name: Determine added markdown files (merged PR)
        if: ${{ github.event.action == 'closed' && github.event.pull_request.merged == true }}
        id: added_closed
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              per_page: 100,
            });
            const added = files
              .filter(f => f.status === 'added' && f.filename.endsWith('.md'))
              .map(f => f.filename)
              .join('\n');
            core.setOutput('added_files', added);

      - name: Create added file list variable
        id: collect
        run: |
          FILES="${{ steps.added_closed.outputs.added_files }}"
          echo "FILES=$FILES" >> $GITHUB_ENV
          echo "Collected added files:"; echo "$FILES"

      - name: Step 1 - Assign sidebar positions
        if: ${{ env.FILES != '' && github.event.pull_request.merged == true }}
        run: |
          node scripts/assign-sidebar-position.js "$FILES"

      - name: Step 1.5 - Clear auto-generated region (between markers)
        if: ${{ env.FILES != '' && github.event.pull_request.merged == true }}
        run: |
          node scripts/clear-auto-region.js $FILES

      - name: Step 2 - Add imports based on frontmatter
        if: ${{ env.FILES != '' && github.event.pull_request.merged == true }}
        run: |
          node scripts/add-imports.js $FILES

      - name: Step 3 - Add components based on frontmatter
        if: ${{ env.FILES != '' && github.event.pull_request.merged == true }}
        run: |
          node scripts/add-components.js $FILES

      - name: Commit changes to stg
        if: ${{ env.FILES != '' && github.event.pull_request.merged == true }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add $FILES || true
          git commit -m "chore(ci): post-merge cleanup (sidebar, imports, components)" || echo "No changes"
          git push
